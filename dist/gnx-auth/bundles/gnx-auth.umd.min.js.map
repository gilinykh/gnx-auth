{"version":3,"sources":["ng://@gnx/auth/lib/gnx-auth.service.ts","ng://@gnx/auth/lib/guards/allow-non-logged-user.guard.ts","ng://@gnx/auth/lib/guards/require-logged-user.guard.ts","ng://@gnx/auth/lib/components/gnx-auth.component.ts","ng://@gnx/auth/lib/interceptors/gnx-apply-token-interceptor.ts","ng://@gnx/auth/lib/interceptors/gnx-refresh-token-interceptor.ts","ng://@gnx/auth/lib/gnx-auth.module.ts"],"names":["GnxAuthService","prototype","setTranslatorService","translatorService","this","init","matchings","window","location","search","match","code","getTokensByCode","tryToGetTokensFromCookieOrStorage","subscribe","initialized","getToken","accessToken$","asObservable","_this","params","URLSearchParams","append","clientId","getRedirectUri","headers","HttpHeaders","Content-type","Authorization","btoa","http","post","authServerUrl","AUTH_SERVER_TOKEN_ENDPOINT","toString","tokenData","saveTokens","next","accessToken","removeCodeParamAndNavigateToTheSamePage","then","err","getAccessTokenByRefreshToken","pipe","switchMap","val","redirectToLoginPage","href","AUTH_SERVER_LOGIN_ENDPOINT","redirectToSignUpPage","AUTH_SERVER_SIGN_UP_ENDPOINT","logout","deleteTokens","navigateToTheSamePage","retrieveUserLanguageFromServer","get","AUTH_SERVER_LANGUAGE_ENDPOINT","res","locale","getCurrentLang","toLowerCase","userLanguage","useLanguage","setDefaultUserLanguage","isValidToken","of","refreshToken","encodedToken","cookieService","ACCESS_TOKEN_COOKIE_NAME","decodedToken","decodeToken","removeAccessTokenFromCookie","REFRESH_TOKEN_COOKIE_NAME","getNewTokensByRefreshToken","tap","map","catchError","removeRefreshTokenFromCookie","queryParams","route","snapshot","queryParamMap","keys","forEach","k","currentUrlPath","getCurrentUrlPath","router","navigate","relativeTo","decodedAccessToken","access_token","acExpireDate","Date","exp","set","COOKIE_PATH","cookieDomainName","decodedRefreshToken","refresh_token","rtExpireDate","url","indexOf","substr","body","token","expirationSeconds","getTime","cookieValue","expireDate","jwtHelper","replace","Injectable","args","providedIn","HttpClient","CookieService","Router","ActivatedRoute","Inject","env","JwtHelperService","ReplaySubject","AllowNonLoggedUserGuard","canActivate","auth","RequireLoggedUserGuard","GnxAuthComponent","ngOnInit","service","userName","user_name","isLoggedIn","login","signUp","translate","text","instant","Component","selector","template","Input","redirectToLoginPageIfUserNotLoggedIn","GnxApplyTokenInterceptor","intercept","req","gnxAuthService","first","clone","setHeaders","request","handle","GnxRefreshTokenInterceptor","startsWith","HttpErrorResponse","status","notTriedYet","newRequest","throwError","GnxAuthModule","forRoot","environment","ngModule","providers","provide","useClass","useValue","NgModule","declarations","imports","BrowserModule","exports","HTTP_INTERCEPTORS","multi"],"mappings":"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","sourcesContent":["import {Inject, Injectable} from '@angular/core';\r\nimport {HttpClient, HttpHeaders} from '@angular/common/http';\r\nimport {Observable, of, ReplaySubject, Subject} from 'rxjs';\r\nimport {catchError, map, switchMap, tap} from 'rxjs/operators';\r\nimport {Token, TokenData, Translateable} from './gnx-models';\r\nimport {CookieService} from \"ngx-cookie-service\";\r\nimport {JwtHelperService} from '@auth0/angular-jwt';\r\nimport {ActivatedRoute, Router} from \"@angular/router\";\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class GnxAuthService {\r\n  readonly AUTH_SERVER_TOKEN_ENDPOINT = '/oauth/token';\r\n  readonly AUTH_SERVER_LOGIN_ENDPOINT = '/oauth/authorize';\r\n  readonly AUTH_SERVER_SIGN_UP_ENDPOINT = '/registration';\r\n  readonly AUTH_SERVER_LANGUAGE_ENDPOINT = '/api/accounts/current/locale';\r\n  readonly ACCESS_TOKEN_COOKIE_NAME = 'access_token';\r\n  readonly REFRESH_TOKEN_COOKIE_NAME = 'refresh_token';\r\n  readonly COOKIE_PATH = '/';\r\n\r\n  private initialized = false;\r\n\r\n  clientId: string;\r\n  authServerUrl: string;\r\n  cookieDomainName: string;\r\n\r\n  private jwtHelper = new JwtHelperService();\r\n\r\n  private accessToken$: Subject<Token> = new ReplaySubject<Token>(1);\r\n  private accessToken: Token;\r\n  private refreshToken: Token;\r\n\r\n  private translatorService: Translateable;\r\n\r\n  private userLanguage: string;\r\n\r\n  constructor(private http: HttpClient,\r\n              private cookieService: CookieService,\r\n              private router: Router,\r\n              private route: ActivatedRoute,\r\n              @Inject('env') private env) {\r\n\r\n    this.clientId = env.clientId;\r\n    this.authServerUrl = env.authServerUrl;\r\n    this.cookieDomainName = env.cookieDomainName;\r\n  }\r\n\r\n  setTranslatorService(translatorService: Translateable) {\r\n    this.translatorService = translatorService;\r\n  }\r\n\r\n  init() {\r\n    // intercept request with 'code' param to get token by the code\r\n    let matchings = window.location.search.match(/code=(.+?)(&.+)?$/);\r\n    let code = matchings ? matchings[1] : null;\r\n    if (code) {\r\n      this.getTokensByCode(code);\r\n    } else {\r\n      this.tryToGetTokensFromCookieOrStorage().subscribe();\r\n    }\r\n    this.initialized = true;\r\n  }\r\n\r\n  getToken(): Observable<Token> {\r\n    if (!this.initialized) {\r\n      this.init();\r\n    }\r\n    return this.accessToken$.asObservable();\r\n  }\r\n\r\n  getTokensByCode(code: string) {\r\n    const params = new URLSearchParams();\r\n    params.append('grant_type', 'authorization_code');\r\n    params.append('client_id', this.clientId);\r\n    params.append('redirect_uri', this.getRedirectUri());\r\n    params.append('code', code);\r\n\r\n    const headers = new HttpHeaders({\r\n      'Content-type': 'application/x-www-form-urlencoded; charset=utf-8',\r\n      'Authorization': 'Basic ' + btoa(this.clientId + ':secret')\r\n    });\r\n\r\n    this.http.post<TokenData>(this.authServerUrl + this.AUTH_SERVER_TOKEN_ENDPOINT, params.toString(),\r\n      {headers: headers}).subscribe(tokenData => {\r\n        this.saveTokens(tokenData);\r\n        this.accessToken$.next(this.accessToken);\r\n        this.removeCodeParamAndNavigateToTheSamePage().then();\r\n      },\r\n      err => this.accessToken$.next(null));\r\n  }\r\n\r\n  getAccessTokenByRefreshToken(): Observable<Token> {\r\n    return this.tryToGetTokensFromCookieOrStorage().pipe(\r\n      switchMap(val => this.getToken())\r\n    );\r\n  }\r\n\r\n  redirectToLoginPage() {\r\n    window.location.href = `${this.authServerUrl}${this.AUTH_SERVER_LOGIN_ENDPOINT}` +\r\n      `?response_type=code&client_id=${this.clientId}&redirect_uri=${this.getRedirectUri()}`;\r\n  }\r\n\r\n  redirectToSignUpPage() {\r\n    window.location.href = `${this.authServerUrl}${this.AUTH_SERVER_SIGN_UP_ENDPOINT}`;\r\n  }\r\n\r\n  logout() {\r\n    this.deleteTokens();\r\n    this.accessToken$.next(null);\r\n    this.navigateToTheSamePage().then();\r\n  }\r\n\r\n  retrieveUserLanguageFromServer() {\r\n    this.http.get<{ locale: string }>(this.authServerUrl + this.AUTH_SERVER_LANGUAGE_ENDPOINT)\r\n      .subscribe(res => {\r\n        if (res && res.locale !== this.translatorService.getCurrentLang().toLowerCase()) {\r\n          this.userLanguage = res.locale;\r\n          this.translatorService.useLanguage(this.userLanguage);\r\n        }\r\n      });\r\n  }\r\n\r\n  setDefaultUserLanguage() {\r\n    this.userLanguage = this.translatorService.getCurrentLang();\r\n  }\r\n\r\n  private tryToGetTokensFromCookieOrStorage(): Observable<boolean> {\r\n    if (this.isValidToken(this.accessToken)) {\r\n      this.accessToken$.next(this.accessToken);\r\n      return of(true);\r\n    }\r\n\r\n    // look for access_token in cookie\r\n    let encodedToken = this.cookieService.get(this.ACCESS_TOKEN_COOKIE_NAME);\r\n    let decodedToken = this.decodeToken(encodedToken);\r\n    if (this.isValidToken(decodedToken)) {\r\n      this.accessToken = decodedToken;\r\n      this.accessToken$.next(decodedToken);\r\n      return of(true);\r\n    } else {\r\n      this.removeAccessTokenFromCookie();\r\n    }\r\n\r\n    // look for a refresh token in cookie\r\n    let refreshToken: Token;\r\n    if (this.refreshToken) {\r\n      refreshToken = this.refreshToken;\r\n    } else {\r\n      refreshToken = this.decodeToken(this.cookieService.get(this.REFRESH_TOKEN_COOKIE_NAME));\r\n    }\r\n    if (this.isValidToken(refreshToken)) {\r\n      return this.getNewTokensByRefreshToken(refreshToken).pipe(\r\n        tap(tokenData => {\r\n          this.saveTokens(tokenData);\r\n          this.accessToken$.next(this.accessToken);\r\n        }),\r\n        map(tokenData => !!tokenData),\r\n        catchError(err => {\r\n          this.removeRefreshTokenFromCookie();\r\n          this.accessToken$.next(null);\r\n          return of(false);\r\n        })\r\n      );\r\n    } else {\r\n      this.removeRefreshTokenFromCookie();\r\n    }\r\n\r\n    this.accessToken$.next(null);\r\n    return of(false);\r\n  }\r\n\r\n  private removeCodeParamAndNavigateToTheSamePage(): Promise<boolean> {\r\n    let queryParams: any = {};\r\n    let params = this.route.snapshot.queryParamMap;\r\n    params.keys.forEach(k => {\r\n      if (k !== 'code') {\r\n        queryParams[k] = params.get(k);\r\n      }\r\n    });\r\n\r\n    let currentUrlPath = this.getCurrentUrlPath();\r\n    return this.router.navigate(\r\n      [currentUrlPath],\r\n      {\r\n        relativeTo: this.route,\r\n        queryParams: queryParams,\r\n      });\r\n  }\r\n\r\n  private navigateToTheSamePage(): Promise<boolean> {\r\n    let queryParams: any = {};\r\n    let params = this.route.snapshot.queryParamMap;\r\n    params.keys.forEach(k => {\r\n        queryParams[k] = params.get(k);\r\n    });\r\n\r\n    let currentUrlPath = this.getCurrentUrlPath();\r\n    return this.router.navigate(\r\n      [currentUrlPath],\r\n      {\r\n        relativeTo: this.route,\r\n        queryParams: queryParams,\r\n      });\r\n  }\r\n\r\n  private saveTokens(tokenData: TokenData) {\r\n    if (tokenData) {\r\n      let decodedAccessToken = this.decodeToken(tokenData.access_token);\r\n      let acExpireDate = new Date(decodedAccessToken.exp * 1000);\r\n      this.cookieService.set(this.ACCESS_TOKEN_COOKIE_NAME, tokenData.access_token, acExpireDate, this.COOKIE_PATH, this.cookieDomainName);\r\n      this.accessToken = decodedAccessToken;\r\n\r\n      let decodedRefreshToken = this.decodeToken(tokenData.refresh_token);\r\n      let rtExpireDate = new Date(decodedRefreshToken.exp * 1000);\r\n      this.cookieService.set(this.REFRESH_TOKEN_COOKIE_NAME, tokenData.refresh_token, rtExpireDate, this.COOKIE_PATH, this.cookieDomainName);\r\n      this.refreshToken = this.decodeToken(tokenData.refresh_token);\r\n    }\r\n  }\r\n\r\n  private getCurrentUrlPath() {\r\n    let url = this.router.url;\r\n    if (url.indexOf('?') > 0) {\r\n      url = url.substr(0, url.indexOf('?'))\r\n    }\r\n    return url;\r\n  }\r\n\r\n  private getNewTokensByRefreshToken(refreshToken: Token): Observable<TokenData> {\r\n    const headers = new HttpHeaders({\r\n      'Content-type': 'application/x-www-form-urlencoded; charset=utf-8',\r\n      'Authorization': 'Basic ' + btoa(this.clientId + ':secret')\r\n    });\r\n\r\n    let body = new URLSearchParams();\r\n    body.set('grant_type', 'refresh_token');\r\n    body.set('refresh_token', refreshToken.encodedToken);\r\n\r\n    return this.http.post<TokenData>(this.authServerUrl + this.AUTH_SERVER_TOKEN_ENDPOINT, body.toString(), {headers: headers});\r\n  }\r\n\r\n  private isValidToken(token: Token): boolean {\r\n    if (!token) {\r\n      return false;\r\n    }\r\n    let expirationSeconds = token.exp;\r\n    return expirationSeconds && (new Date().getTime() < expirationSeconds * 1000);\r\n  }\r\n\r\n  private deleteTokens() {\r\n    this.removeAccessTokenFromCookie();\r\n    this.accessToken = null;\r\n    this.removeRefreshTokenFromCookie();\r\n    this.refreshToken = null;\r\n  }\r\n\r\n  private removeAccessTokenFromCookie() {\r\n    let cookieValue = this.cookieService.get(this.ACCESS_TOKEN_COOKIE_NAME);\r\n    if (cookieValue) {\r\n      let expireDate = new Date(0);\r\n      this.cookieService.set(this.ACCESS_TOKEN_COOKIE_NAME, cookieValue, expireDate, this.COOKIE_PATH, this.cookieDomainName);\r\n    }\r\n  }\r\n\r\n  private removeRefreshTokenFromCookie() {\r\n    let cookieValue = this.cookieService.get(this.REFRESH_TOKEN_COOKIE_NAME);\r\n    if (cookieValue) {\r\n      let expireDate = new Date(0);\r\n      this.cookieService.set(this.REFRESH_TOKEN_COOKIE_NAME, cookieValue, expireDate, this.COOKIE_PATH, this.cookieDomainName);\r\n    }\r\n  }\r\n\r\n  private decodeToken(encodedToken: string): Token {\r\n    if (!encodedToken) {\r\n      return null;\r\n    }\r\n\r\n    let decodedToken = this.jwtHelper.decodeToken(encodedToken) as Token;\r\n    if (decodedToken) {\r\n      decodedToken.encodedToken = encodedToken;\r\n    }\r\n\r\n    return decodedToken;\r\n  }\r\n\r\n  private getRedirectUri(): string {\r\n    return window.location.href.replace(/^(http[s]?:\\/\\/[a-zA-Z\\\\.:0-9]+)(\\/.*)$/, '$1');\r\n  }\r\n\r\n}\r\n","import {Injectable} from \"@angular/core\";\r\nimport {CanActivate, Router} from \"@angular/router\";\r\nimport {GnxAuthService} from \"../gnx-auth.service\";\r\nimport {Observable, of} from \"rxjs\";\r\nimport {map, switchMap} from \"rxjs/operators\";\r\n\r\n@Injectable({\r\n  providedIn: 'root',\r\n})\r\nexport class AllowNonLoggedUserGuard implements CanActivate {\r\n  constructor(public auth: GnxAuthService, public router: Router) {}\r\n  canActivate(): Observable<boolean> {\r\n    return of(null).pipe(\r\n      switchMap(() => this.auth.getToken()),\r\n      map(token => {\r\n        return true;\r\n      }) // always returns true, needed to try to get token from cookie\r\n    );\r\n  }\r\n}\r\n","import {Injectable} from \"@angular/core\";\r\nimport {CanActivate, Router} from \"@angular/router\";\r\nimport {GnxAuthService} from \"../gnx-auth.service\";\r\nimport {Observable} from \"rxjs\";\r\nimport {map} from \"rxjs/operators\";\r\n\r\n@Injectable({\r\n  providedIn: 'root',\r\n})\r\nexport class RequireLoggedUserGuard implements CanActivate {\r\n  constructor(public auth: GnxAuthService, public router: Router) {}\r\n  canActivate(): Observable<boolean> {\r\n    return this.auth.getToken().pipe(\r\n      map(token => {\r\n        if (!token) {\r\n          this.auth.redirectToLoginPage();\r\n          return false;\r\n        }\r\n        return true;\r\n      }),\r\n    );\r\n  }\r\n}\r\n","import {Component, Inject, Input, OnInit} from '@angular/core';\r\nimport {GnxAuthService} from \"../gnx-auth.service\";\r\nimport {Translateable} from \"../gnx-models\";\r\n\r\n@Component({\r\n  selector: 'gnx-auth',\r\n  templateUrl: './gnx-auth.component.html',\r\n  styleUrls: ['./gnx-auth.component.scss']\r\n})\r\nexport class GnxAuthComponent implements OnInit {\r\n\r\n  @Input() redirectToLoginPageIfUserNotLoggedIn = true;\r\n\r\n  isLoggedIn: boolean;\r\n  userName: string;\r\n  initialized = false;\r\n\r\n  constructor(private service: GnxAuthService,\r\n              @Inject('TranslatorService') public translatorService: Translateable,\r\n              @Inject('env') public env) {\r\n    service.setTranslatorService(translatorService);\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.service.getToken().subscribe(token => {\r\n      if (token) {\r\n        this.userName = token.user_name;\r\n        this.isLoggedIn = true;\r\n        this.service.retrieveUserLanguageFromServer();\r\n      } else {\r\n        this.userName = null;\r\n        this.isLoggedIn = false;\r\n        this.service.setDefaultUserLanguage();\r\n      }\r\n      this.initialized = true;\r\n    });\r\n  }\r\n\r\n  login() {\r\n    this.service.redirectToLoginPage();\r\n  }\r\n\r\n  signUp() {\r\n    this.service.redirectToSignUpPage();\r\n  }\r\n\r\n  logout() {\r\n    this.service.logout();\r\n    this.isLoggedIn = false;\r\n  }\r\n\r\n  translate(text: string): string {\r\n    return this.translatorService.translate.instant(text);\r\n  }\r\n\r\n}\r\n","import {Injectable} from '@angular/core';\r\nimport {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\r\n\r\nimport {Observable} from 'rxjs';\r\nimport {GnxAuthService} from \"../gnx-auth.service\";\r\nimport {first, map, switchMap} from \"rxjs/operators\";\r\n\r\n@Injectable()\r\nexport class GnxApplyTokenInterceptor implements HttpInterceptor {\r\n\r\n  constructor(private gnxAuthService: GnxAuthService) {\r\n  }\r\n\r\n  intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\r\n    if (req.url.indexOf('/api/') > -1) {\r\n      return this.gnxAuthService.getToken().pipe(\r\n        first(),\r\n        map(token => {\r\n            if (token) {\r\n              return req.clone({\r\n                setHeaders: {\r\n                  Authorization: 'Bearer ' + token.encodedToken\r\n                }\r\n              })\r\n            }\r\n            return req;\r\n          }\r\n        ),\r\n        switchMap(request => next.handle(request)),\r\n      );\r\n    }\r\n    return next.handle(req);\r\n  }\r\n}\r\n","import {Injectable} from '@angular/core';\r\nimport {HttpErrorResponse, HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';\r\n\r\nimport {Observable, throwError} from 'rxjs';\r\nimport {catchError, first, switchMap} from \"rxjs/operators\";\r\nimport {GnxAuthService} from \"../gnx-auth.service\";\r\n\r\n@Injectable()\r\nexport class GnxRefreshTokenInterceptor implements HttpInterceptor {\r\n\r\n  private notTriedYet = true;\r\n\r\n    constructor(private gnxAuthService: GnxAuthService) {\r\n    }\r\n\r\n    intercept(req: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\r\n      if (req.url.startsWith('/api/')) {\r\n        return next.handle(req).pipe(\r\n          catchError(err => {\r\n            if (err instanceof HttpErrorResponse && err.status === 401) { // it seems access token hs expired, try to get new tokens by refresh token\r\n              if (this.notTriedYet) {\r\n                this.notTriedYet = false;\r\n                return this.gnxAuthService.getAccessTokenByRefreshToken().pipe(\r\n                  first(),\r\n                  switchMap(token => {\r\n                    this.notTriedYet = true;\r\n                    if (token) {\r\n                      let newRequest = req.clone({\r\n                        setHeaders: {\r\n                          Authorization: 'Bearer ' + token.encodedToken\r\n                        }\r\n                      });\r\n                      return next.handle(newRequest);\r\n                    }\r\n                    this.gnxAuthService.redirectToLoginPage();\r\n                  })\r\n                );\r\n              } else {\r\n                this.notTriedYet = true;\r\n                this.gnxAuthService.redirectToLoginPage();\r\n              }\r\n            } else {\r\n              return throwError(err);\r\n            }\r\n          })\r\n        );\r\n      }\r\n\r\n      return next.handle(req);\r\n    }\r\n}\r\n","import {ModuleWithProviders, NgModule} from '@angular/core';\r\nimport {BrowserModule} from '@angular/platform-browser';\r\n// LibComponent\r\nimport {GnxAuthComponent} from './components/gnx-auth.component';\r\nimport {CookieService} from \"ngx-cookie-service\";\r\nimport {HTTP_INTERCEPTORS} from \"@angular/common/http\";\r\nimport {GnxApplyTokenInterceptor} from \"./interceptors/gnx-apply-token-interceptor\";\r\nimport {GnxRefreshTokenInterceptor} from \"./interceptors/gnx-refresh-token-interceptor\";\r\nimport {GnxAuthService} from \"./gnx-auth.service\";\r\n\r\n\r\n@NgModule({\r\n  declarations: [\r\n    GnxAuthComponent\r\n  ],\r\n  imports: [\r\n    BrowserModule,\r\n  ],\r\n  exports: [\r\n    GnxAuthComponent\r\n  ],\r\n  providers: [\r\n    CookieService,\r\n    {provide: HTTP_INTERCEPTORS, useClass: GnxApplyTokenInterceptor, multi: true},\r\n    {provide: HTTP_INTERCEPTORS, useClass: GnxRefreshTokenInterceptor, multi: true},\r\n  ]\r\n})\r\nexport class GnxAuthModule {\r\n\r\n  public static forRoot(environment: any, translatorService: any): ModuleWithProviders {\r\n\r\n    return {\r\n      ngModule: GnxAuthModule,\r\n      providers: [\r\n        GnxAuthService,\r\n        {provide: 'TranslatorService', useClass: translatorService},\r\n        {\r\n          provide: 'env',\r\n          useValue: environment\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n"]}